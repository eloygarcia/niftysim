IF (NOT NiftySim_USE_FILE_INCLUDED) 
  SET(NiftySim_USE_FILE_INCLUDED 1)

  INCLUDE_DIRECTORIES(${NiftySim_INCLUDE_DIR})
  LINK_DIRECTORIES(${NiftySim_LIB_DIR})

  SET(NiftySim_CXX_FLAGS "")
  MARK_AS_ADVANCED(NiftySim_CXX_FLAGS)
  SET(NiftySim_NVCC_FLAGS "")
  MARK_AS_ADVANCED(NiftySim_NVCC_FLAGS)
  SET(NiftySim_THIRD_PARTY_LIBRARIES "")
  MARK_AS_ADVANCED(NiftySim_THIRD_PARTY_LIBRARIES)

  IF (NOT NiftySim_USE_NAMESPACE_STD)
    SET(NiftySim_CXX_FLAGS "${NiftySim_CXX_FLAGS} -D_NOT_USING_NAMESPACE_STD_")
  ENDIF (NOT NiftySim_USE_NAMESPACE_STD)

  IF (NiftySim_USE_VIZ)
    FIND_PACKAGE(VTK REQUIRED PATHS "@VTK_DIR@")
    IF(NOT VTK_FOUND)
      MESSAGE(FATAL_ERROR "VTK package not found")
    ENDIF(NOT VTK_FOUND)

    SET(NiftySim_CXX_FLAGS "${NiftySim_CXX_FLAGS} -D_Visualisation_")

    IF (VTK_MAJOR_VERSION LESS 6) 
      INCLUDE(${VTK_USE_FILE})
      LIST(APPEND NiftySim_THIRD_PARTY_LIBRARIES vtkHybrid)
    ELSE ()
      IF (USE_CUDA)
	# CUDA + VTK 6.X hack carried over from CMakeLists.txt, remove ASAP
	INCLUDE_DIRECTORIES(${VTK_INCLUDE_DIRS})
	LINK_DIRECTORIES(${VTK_LIBRARY_DIRS})
      ELSE ()
       INCLUDE(${VTK_USE_FILE})
     ENDIF (USE_CUDA)

     LIST(APPEND NiftySim_THIRD_PARTY_LIBRARIES "@VTK_LIBRARIES@")
    ENDIF (VTK_MAJOR_VERSION LESS 6) 
  ENDIF (NiftySim_USE_VIZ)

  IF (NiftySim_USE_BOOST)
      SET(BOOST_LIBS thread date_time)
      FIND_PACKAGE(Boost COMPONENTS ${BOOST_LIBS} REQUIRED)
      SET(NiftySim_CXX_FLAGS "${NiftySim_CXX_FLAGS} -D_USE_BOOST_")
      LIST(APPEND NiftySim_THIRD_PARTY_LIBRARIES ${Boost_LIBRARIES})
      INCLUDE_DIRECTORIES(${Boost_INCLUDE_DIRS})
      LINK_DIRECTORIES(${Boost_LIBRARY_DIRS})
  ENDIF (NiftySim_USE_BOOST)

  IF (NiftySim_USE_CUDA) 
    SET(NiftySim_NVCC_FLAGS "${NiftySim_NVCC_FLAGS};-D_GPU_")
    SET(NiftySim_CXX_FLAGS "${NiftySim_CXX_FLAGS} -D_GPU_")

    IF (NiftySim_USE_GPU_GP_CONTACT)
      SET(NiftySim_NVCC_FLAGS "${NiftySim_NVCC_FLAGS};-DGPU_GP_CONTACT;-gencode=arch=${NiftySim_CUDA_ARCH},code=${NiftySim_CUDA_CODE};-D_USE_THRUST_;-D_USE_CUDA_ATOMICS")
      SET(NiftySim_CXX_FLAGS "${NiftySim_CXX_FLAGS} -DGPU_GP_CONTACT")
    ENDIF (NiftySim_USE_GPU_GP_CONTACT)

    SET(CUDA_TOOLKIT_ROOT_DIR "@CUDA_TOOLKIT_ROOT_DIR@")
    SET(CUDA_SDK_ROOT_DIR "@CUDA_SDK_ROOT_DIR@")
    FIND_PACKAGE(CUDA REQUIRED)
    
    IF (CUDA_VERSION VERSION_GREATER "5.0" OR CUDA_VERSION VERSION_EQUAL "5.0")
      FIND_PATH(CUDA_SDK_COMMON_INCLUDE_DIR
	helper_cuda.h
	PATHS ${CUDA_SDK_SEARCH_PATH} "@CUDA_SDK_COMMON_INCLUDE_DIR@"
	PATH_SUFFIXES "common/inc"
	DOC "Location of helper_cuda.h"
	NO_DEFAULT_PATH)
      MARK_AS_ADVANCED(CUDA_SDK_COMMON_INCLUDE_DIR)

      INCLUDE_DIRECTORIES(${CUDA_SDK_COMMON_INCLUDE_DIR})
      CUDA_INCLUDE_DIRECTORIES(${CUDA_SDK_COMMON_INCLUDE_DIR})

      SET(NiftySim_NVCC_FLAGS "${NiftySim_NVCC_FLAGS};-D_CUDA_5PLUS_SDK")
      SET(NiftySim_CXX_FLAGS "${NiftySim_CXX_FLAGS} -D_CUDA_5PLUS_SDK")     

    ELSE ()
      FIND_PATH(CUDA_CUT_INCLUDE_DIR
	cutil.h
	PATHS ${CUDA_SDK_SEARCH_PATH} "@CUDA_CUT_INCLUDE_DIR@"
	PATH_SUFFIXES "common/inc"
	DOC "Location of cutil.h"
	NO_DEFAULT_PATH)
    ENDIF ()

    INCLUDE_DIRECTORIES(${CUDA_CUT_INCLUDE_DIR})
    CUDA_INCLUDE_DIRECTORIES(${CUDA_CUT_INCLUDE_DIR})    
  ENDIF (NiftySim_USE_CUDA)

  SET(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} ${NiftySim_CXX_FLAGS}")
  IF (NiftySim_USE_CUDA)
    SET(CUDA_NVCC_FLAGS "${CUDA_NVCC_FLAGS} ${NiftySim_NVCC_FLAGS}")
  ENDIF (NiftySim_USE_CUDA)
ENDIF (NOT NiftySim_USE_FILE_INCLUDED)